name: Flashfood Scraper

on:
  schedule:
    # 美东 09:30 (UTC 14:30)
    - cron: '30 14 * * *'
    # 美西 09:30 (UTC 17:30)  
    - cron: '30 17 * * *'
    # 美东 16:30 (UTC 21:30)
    - cron: '30 21 * * *'
    # 美西 16:30 (UTC 00:30 次日)
    - cron: '30 0 * * *'
    # 美东 20:30 (UTC 01:30 次日)
    - cron: '30 1 * * *'
    # 美西 20:30 (UTC 04:30 次日)
    - cron: '30 4 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    outputs:
      zone: ${{ steps.determine.outputs.zone }}
      status: ${{ job.status }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install curl_cffi pandas pytz
          
      - name: Determine timezone to scrape
        id: determine
        run: |
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          UTC_TIME="${HOUR}:${MINUTE}"
          echo "Current UTC time: $UTC_TIME"
          
          if [[ "$UTC_TIME" == "14:30" ]] || [[ "$UTC_TIME" == "21:30" ]] || [[ "$UTC_TIME" == "01:30" ]]; then
            echo "zone=east" >> $GITHUB_OUTPUT
            echo "Running EAST (Toronto, Detroit)"
          elif [[ "$UTC_TIME" == "17:30" ]] || [[ "$UTC_TIME" == "00:30" ]] || [[ "$UTC_TIME" == "04:30" ]]; then
            echo "zone=west" >> $GITHUB_OUTPUT
            echo "Running WEST (Vancouver, Seattle)"
          else
            echo "zone=unknown" >> $GITHUB_OUTPUT
          fi
          
      - name: Run East Scraper
        if: steps.determine.outputs.zone == 'east'
        id: scrape_east
        run: |
          python flashfood_east.py
          echo "scraped_east=true" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Run West Scraper  
        if: steps.determine.outputs.zone == 'west'
        id: scrape_west
        run: |
          python flashfood_west.py
          echo "scraped_west=true" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Check scrape result
        id: check_result
        run: |
          if [[ "${{ steps.scrape_east.outcome }}" == "failure" ]] || [[ "${{ steps.scrape_west.outcome }}" == "failure" ]]; then
            echo "scrape_failed=true" >> $GITHUB_OUTPUT
            echo "error_msg=Scraper failed to fetch data" >> $GITHUB_OUTPUT
            exit 1
          elif [[ "${{ steps.scrape_east.outcome }}" == "success" ]] || [[ "${{ steps.scrape_west.outcome }}" == "success" ]]; then
            echo "scrape_failed=false" >> $GITHUB_OUTPUT
          else
            echo "scrape_failed=true" >> $GITHUB_OUTPUT
            echo "error_msg=No scraper was executed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Upload Data
        if: steps.check_result.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: data-${{ github.run_id }}
          path: data/*.csv
          retention-days: 1

  summarize:
    needs: scrape
    if: needs.scrape.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Data
        uses: actions/download-artifact@v4
        with:
          name: data-${{ github.run_id }}
          path: data/
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install pandas
          
      - name: Run Summarize
        id: summarize_step
        run: python summarize.py
        continue-on-error: true
        
      - name: Check summarize result
        id: check_summarize
        run: |
          if [[ "${{ steps.summarize_step.outcome }}" == "failure" ]]; then
            echo "summarize_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "summarize_failed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit and Push Results
        if: steps.check_summarize.outcome == 'success'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add summary/
          git add data/
          git commit -m "Update data: $(date -u +%Y-%m-%d-%H:%M)" || echo "No changes to commit"
          git push

  notify-success:
    needs: [scrape, summarize]
    if: always() && needs.scrape.result == 'success' && needs.summarize.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Send Success Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "✅ Flashfood 爬虫成功 - ${{ github.run_id }}"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions
          html_body: |
            <h2>✅ Flashfood 数据抓取成功</h2>
            <p><strong>运行时间:</strong> ${{ github.event.schedule }}</p>
            <p><strong>抓取区域:</strong> ${{ needs.scrape.outputs.zone }}</p>
            <p><strong>运行ID:</strong> ${{ github.run_id }}</p>
            <p><strong>查看详情:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">点击这里</a></p>

  notify-failure:
    needs: [scrape, summarize]
    if: always() && (needs.scrape.result == 'failure' || needs.summarize.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "❌ Flashfood 爬虫失败 - ${{ github.run_id }}"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: GitHub Actions
          html_body: |
            <h2>❌ Flashfood 数据抓取失败</h2>
            <p><strong>运行时间:</strong> ${{ github.event.schedule }}</p>
            <p><strong>失败环节:</strong> 
              ${{ needs.scrape.result == 'failure' && '数据抓取 (Scrape)' || '' }}
              ${{ needs.summarize.result == 'failure' && '数据汇总 (Summarize)' || '' }}
            </p>
            <p><strong>运行ID:</strong> ${{ github.run_id }}</p>
            <p><strong>查看日志:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">点击这里查看错误详情</a></p>
            <p>请尽快检查问题！</p>
